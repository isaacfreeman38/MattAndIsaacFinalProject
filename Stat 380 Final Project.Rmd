---
title: "Stat 380 Final Project"
author: "Isaac Freeman and Matt Secen"
date: "Due: May 1, 2019"
output: html_notebook
---

# Front matter

```{r echo=TRUE, message=FALSE}
# always clean up R environment
rm(list = ls())

# load all packages here
library("httr")
library("readxl")
library(dplyr)
library(tidyr)
library(rvest)
library(ggplot2)

# upload data here

GET("https://query.data.world/s/r7tdedfpzdgrras4zhjswl7pdi733r", write_disk(tf <- tempfile(fileext = ".xlsx")))
state_incomes <- read_excel(tf)

url <- "https://wallethub.com/edu/happiest-states/6959/" 
tables <- 
  url %>%
    read_html() %>% 
      html_nodes("table")
Happiness <- html_table(tables[[1]])

# user-defined functions here (if any)
makeGraph <- function(df, yaxis, xaxis) {
  df %>%
  select(yaxis, xaxis) %>%
  ggplot(aes(y = yaxis, x = xaxis)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = 0)
}
```

```{r}
Happiness
```

```{r}
state_incomes = rename(state_incomes, State = `Table with row headers in column A and column headers in rows 4 and 5`)
```

```{r}
state_incomes
```

Fix the second table so the columns have the correct names.
Join the two tables together. Gather the median and standard error of incomes by state and/or year.
Use a user defined function and/ or loop to change the column names.
Use a loop to test the happiness and income for each state.
Use a vectorized function

Visualization for each states median income and the change over time.
Use the standard error to create buffers for the lines
Show the happiness compared to the same years median income and see if there is a correlation between the two. (geomscatter)

Perform a simulation to see what type of happiness correlates best with overall happiness.

```{r}
JoinedTablesRaw <-
  merge(Happiness, state_incomes, by = "State")
JoinedTablesRaw
```
  
  j - 3
```{r}
# Rename a column in R
names(JoinedTablesRaw)[7]<- 2014
names(JoinedTablesRaw)[8]<- 2014

TableWYears <- JoinedTablesRaw
#TableWYears

for(i in 9:66)
  names(TableWYears)[i]<- 2017 - trunc((i+1)/2)
for(j in 4:33)
  names(TableWYears)[(j)*2]<- -2017 + j

names(TableWYears)[8]<- -2014
names(TableWYears)[2]<- "OverallRank"
names(TableWYears)[3]<- "TotalScore"
names(TableWYears)[4]<- "EPRank"
names(TableWYears)[5]<- "WERank"
names(TableWYears)[6]<- "CERank"

TableWYears
```

```{r}
GatheredIncome <-
  TableWYears %>% 
    gather(key = year, value = median, "1984", "1985", "1986", "1987", "1988", "1989", "1990", "1991", "1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2014") %>%
    select(State, year, median) %>%
    filter(State == "Pennsylvania" | State == "West Virginia" | 
           State == "Hawaii" | State == "Kansas")

#as.numeric(GatheredIncome$year)
#as.numeric(GatheredIncome$median)

GatheredIncome %>%
  ggplot(aes(x = year, y = median, color = State, group = 
               as.factor(State))) + 
  geom_line() + 
  geom_point() + 
  ylab("Median Income") + 
  xlab("Year") + 
  theme(axis.text.y = element_blank()) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) 
```

```{r}

makeGraph(TableWYears, TableWYears$OverallRank, TableWYears$EPRank) +
  ylab("Overall Happiness Ranking") + 
  xlab("Emotional/Physical Well-Being Ranking")

makeGraph(TableWYears, TableWYears$OverallRank, TableWYears$WERank) +
  ylab("Overall Happiness Ranking") + 
  xlab("Work Environment Ranking")

makeGraph(TableWYears, TableWYears$OverallRank, TableWYears$CERank) +
  ylab("Overall Happiness Ranking") + 
  xlab("Community Environment Ranking")

cor(TableWYears$OverallRank, TableWYears$EPRank)
cor(TableWYears$OverallRank, TableWYears$WERank)
cor(TableWYears$OverallRank, TableWYears$CERank)
```


```{r}
require(rpart)
decision_tree_model <-
  rpart(OverallRank ~ CERank, WERank, data = TableWYears)
decision_tree_model
```

```{r}
require(partykit)
plot(as.party(decision_tree_model))
```

```{r}
avgIncomeTable <-
  TableWYears %>%
    mutate(totalIncome = as.numeric(TableWYears$`1984`) + as.numeric(TableWYears$`1985`) + as.numeric(TableWYears$`1986`) + as.numeric(TableWYears$`1987`) + as.numeric(TableWYears$`1988`) + as.numeric(TableWYears$`1989`) + as.numeric(TableWYears$`1990`) + as.numeric(TableWYears$`1991`) + as.numeric(TableWYears$`1992`) + as.numeric(TableWYears$`1993`) + as.numeric(TableWYears$`1994`) + as.numeric(TableWYears$`1995`) + as.numeric(TableWYears$`1996`) + as.numeric(TableWYears$`1997`) + as.numeric(TableWYears$`1998`) + as.numeric(TableWYears$`1999`) + as.numeric(TableWYears$`2000`) + as.numeric(TableWYears$`2001`) + as.numeric(TableWYears$`2002`) + as.numeric(TableWYears$`2003`) + as.numeric(TableWYears$`2004`) + as.numeric(TableWYears$`2005`) + as.numeric(TableWYears$`2006`) + as.numeric(TableWYears$`2007`) + as.numeric(TableWYears$`2008`) + as.numeric(TableWYears$`2009`) + as.numeric(TableWYears$`2010`) + as.numeric(TableWYears$`2011`) + as.numeric(TableWYears$`2012`) + as.numeric(TableWYears$`2014`))
avgIncomeTable  
```

```{r}
avgIncomeTable <-
  avgIncomeTable %>%
  mutate(avgIncome = totalIncome/30)
avgIncomeTable$incomeRank <- NA
avgIncomeTable$incomeRank[order(-avgIncomeTable$avgIncome)] <- 1:nrow(avgIncomeTable)
avgIncomeTable
```

```{r}
avgIncomeTable <-
  avgIncomeTable %>%
  mutate(HappinessDecile = (as.numeric(OverallRank) %/% 5) + 1)
avgIncomeTable
```

```{r}
barGraphData <- rbind(avgIncomeTable$OverallRank, avgIncomeTable$incomeRank)

barplot(barGraphData, names.arg = avgIncomeTable$State, beside=T) +
  facet_wrap(~ avgIncomeTable$HappinessDecile)
```