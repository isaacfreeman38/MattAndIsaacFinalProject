---
title: "Stat 380 Final Project"
author: "Isaac Freeman and Matt Secen"
date: "Due: May 1, 2019"
output: html_notebook
---

# Front matter

Here we get our project started by downloading the necessary packages and uploading the data we will be analyzing. We got our median income data from the data world website and the happiness rating from wallethub. In the front matter we also added some user defined functions such as when we were making the graphs.
```{r echo=TRUE, message=FALSE}
# always clean up R environment
rm(list = ls())

# load all packages here
library("httr")
library("readxl")
library(dplyr)
library(tidyr)
library(rvest)
library(ggplot2)

# upload data here

GET("https://query.data.world/s/r7tdedfpzdgrras4zhjswl7pdi733r", write_disk(tf <- tempfile(fileext = ".xlsx")))
state_incomes <- read_excel(tf)

url <- "https://wallethub.com/edu/happiest-states/6959/" 
tables <- 
  url %>%
    read_html() %>% 
      html_nodes("table")
Happiness <- html_table(tables[[1]])

# user-defined functions here (if any)
makeGraph <- function(df, yaxis, xaxis) {
  df %>%
  select(yaxis, xaxis) %>%
  ggplot(aes(y = yaxis, x = xaxis)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = 0)
}

happinessGraph <- function(newdf, df, column, value, binded) {
  newdf
    df %>%
     filter(column == value)
    binded <- rbind(df$OverallRank, df$incomeRank)
  barplot(binded, names.arg = df1$State, beside=T)
}
```

Here is a look at the happiness dataset that we uploaded from wallethub. It includes the overall rank of each states happiness along with a total score and different types of happiness that help make up the final score.
```{r}
Happiness
```

Here we changed the name of one of the columns in the state_incomes dataset. We uploaded this data set from dataworld and it contains the median and standard deviations of each state ranging from 1984-2014
```{r}
state_incomes = rename(state_incomes, State = `Table with row headers in column A and column headers in rows 4 and 5`)

state_incomes
```

This is where we joined the two tables together by "State" using the merge function. This way we can compare how (median) income affects happiness and try to answer the question "Can money buy you happiness?"
```{r}
JoinedTablesRaw <-
  merge(Happiness, state_incomes, by = "State")
JoinedTablesRaw
```
  
We clean up the joined data table by changing the column names to match the year the column belongs to. A loop was useful here to change most of them as the columns were in order by year but some of them did need to be handled individually as they did not fit the pattern.
```{r}
# Rename a column in R
names(JoinedTablesRaw)[7]<- 2014
names(JoinedTablesRaw)[8]<- 2014

TableWYears <- JoinedTablesRaw
#TableWYears

for(i in 9:66)
  names(TableWYears)[i]<- 2017 - trunc((i+1)/2)
for(j in 4:33)
  names(TableWYears)[(j)*2]<- -2017 + j

names(TableWYears)[8]<- -2014
names(TableWYears)[2]<- "OverallRank"
names(TableWYears)[3]<- "TotalScore"
names(TableWYears)[4]<- "EPRank"
names(TableWYears)[5]<- "WERank"
names(TableWYears)[6]<- "CERank"

TableWYears
```

Here we were able to use the gather function to look at the median income of different states over the years. We chose Hawaii, Kansas, and West Virginia because they were the 1st, 25th, and 50th happiest ranked state respectively. We wanted to see if there were big differences between the extremes and looking at the graph income does play a role in predicting happiness.
```{r}
GatheredIncome <-
  TableWYears %>% 
    gather(key = year, value = median, "1984", "1985", "1986", "1987", "1988", "1989", "1990", "1991", "1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999", "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2014") %>%
    select(State, year, median) %>%
    filter(State == "Pennsylvania" | State == "West Virginia" | 
           State == "Hawaii" | State == "Kansas")

#as.numeric(GatheredIncome$year)
#as.numeric(GatheredIncome$median)

GatheredIncome %>%
  ggplot(aes(x = year, y = median, color = State, group = 
               as.factor(State))) + 
  geom_line() + 
  geom_point() + 
  ylab("Median Income") + 
  xlab("Year") + 
  theme(axis.text.y = element_blank()) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) 
```

Here we used the user-defined function created earlier to make the base of the graphs looking at how different types of happiness affect overall happiness. We also tested the correlation and determined that Emotional and Physical Well Being plays the biggest role in determining overall happiness, while all three were positively correlated.
```{r}
makeGraph(TableWYears, TableWYears$OverallRank, TableWYears$EPRank) +
  ylab("Overall Happiness Ranking") + 
  xlab("Emotional/Physical Well-Being Ranking")

makeGraph(TableWYears, TableWYears$OverallRank, TableWYears$WERank) +
  ylab("Overall Happiness Ranking") + 
  xlab("Work Environment Ranking")

makeGraph(TableWYears, TableWYears$OverallRank, TableWYears$CERank) +
  ylab("Overall Happiness Ranking") + 
  xlab("Community Environment Ranking")

cor(TableWYears$OverallRank, TableWYears$EPRank)
cor(TableWYears$OverallRank, TableWYears$WERank)
cor(TableWYears$OverallRank, TableWYears$CERank)
```


```{r}
require(rpart)
decision_tree_model <-
  rpart(OverallRank ~ CERank, WERank, data = TableWYears)
decision_tree_model
```

```{r}
require(partykit)
plot(as.party(decision_tree_model))
```

```{r}
avgIncomeTable <-
  TableWYears %>%
    mutate(totalIncome = as.numeric(TableWYears$`1984`) + as.numeric(TableWYears$`1985`) + as.numeric(TableWYears$`1986`) + as.numeric(TableWYears$`1987`) + as.numeric(TableWYears$`1988`) + as.numeric(TableWYears$`1989`) + as.numeric(TableWYears$`1990`) + as.numeric(TableWYears$`1991`) + as.numeric(TableWYears$`1992`) + as.numeric(TableWYears$`1993`) + as.numeric(TableWYears$`1994`) + as.numeric(TableWYears$`1995`) + as.numeric(TableWYears$`1996`) + as.numeric(TableWYears$`1997`) + as.numeric(TableWYears$`1998`) + as.numeric(TableWYears$`1999`) + as.numeric(TableWYears$`2000`) + as.numeric(TableWYears$`2001`) + as.numeric(TableWYears$`2002`) + as.numeric(TableWYears$`2003`) + as.numeric(TableWYears$`2004`) + as.numeric(TableWYears$`2005`) + as.numeric(TableWYears$`2006`) + as.numeric(TableWYears$`2007`) + as.numeric(TableWYears$`2008`) + as.numeric(TableWYears$`2009`) + as.numeric(TableWYears$`2010`) + as.numeric(TableWYears$`2011`) + as.numeric(TableWYears$`2012`) + as.numeric(TableWYears$`2014`))
avgIncomeTable  
```

```{r}
avgIncomeTable <-
  avgIncomeTable %>%
  mutate(avgIncome = totalIncome/30)
avgIncomeTable$incomeRank <- NA
avgIncomeTable$incomeRank[order(-avgIncomeTable$avgIncome)] <- 1:nrow(avgIncomeTable)
avgIncomeTable
```

To make it easier to read the graphs we split them up into groups of ten and then reversed the ranks so the greatest happiness and income have the tallest bars.
```{r}
avgIncomeTable <-
  avgIncomeTable %>%
  mutate(HappinessQuantile = (as.numeric(OverallRank-1) %/% 10) + 1)

avgIncomeTable <-
  avgIncomeTable %>%
    mutate(incomeRank = rank(-incomeRank), OverallRank = 
             rank(-OverallRank))
avgIncomeTable
```
barplot(barGraphData, names.arg = avgIncomeTable$State, beside=T) +
  facet_wrap(~ avgIncomeTable$HappinessQuantile)
  
  
This is where we created the bargraphs comparing the median income and happiness rank of each state individually. We tried to see how good of a predictor money is to happiness and for the most part it does do a good job. While there are some exceptions we think that median income does have a sizeable influence on how happy you are.
```{r}
avgIncomeTable1 <-
  avgIncomeTable %>%
    filter(HappinessQuantile == 1) %>%
      arrange(OverallRank)
barGraphData1 <- rbind(avgIncomeTable1$OverallRank, avgIncomeTable1$incomeRank)
barplot(barGraphData1, names.arg = avgIncomeTable1$State, beside=T)

avgIncomeTable2 <-
  avgIncomeTable %>%
    filter(HappinessQuantile == 2) %>%
      arrange(OverallRank)
barGraphData2 <- rbind(avgIncomeTable2$OverallRank, avgIncomeTable2$incomeRank)
barplot(barGraphData2, names.arg = avgIncomeTable2$State, beside=T)

avgIncomeTable3 <-
  avgIncomeTable %>%
    filter(HappinessQuantile == 3) %>%
      arrange(OverallRank)
barGraphData3 <- rbind(avgIncomeTable3$OverallRank, avgIncomeTable3$incomeRank)
barplot(barGraphData3, names.arg = avgIncomeTable3$State, beside=T)

avgIncomeTable4 <-
  avgIncomeTable %>%
    filter(HappinessQuantile == 4) %>%
      arrange(OverallRank)
barGraphData4 <- rbind(avgIncomeTable4$OverallRank, avgIncomeTable1$incomeRank)
barplot(barGraphData4, names.arg = avgIncomeTable4$State, beside=T)

avgIncomeTable5 <-
  avgIncomeTable %>%
    filter(HappinessQuantile == 5) %>%
      arrange(OverallRank)
barGraphData5<- rbind(avgIncomeTable5$OverallRank, avgIncomeTable5$incomeRank)
barplot(barGraphData5, names.arg = avgIncomeTable1$State, beside=T)
```

```{r}
avgIncomeTable1 <-
  avgIncomeTable %>%
    filter(HappinessQuantile == 1) %>%
      arrange(OverallRank)
barGraphData1 <- rbind(avgIncomeTable1$OverallRank, avgIncomeTable1$incomeRank)
barplot(barGraphData1, names.arg = avgIncomeTable1$State, beside=T)


```

```{r}
RankDiffSims <- 
  mosaic::do(1000) * 
    avgIncomeTable %>%
    mutate(State = shuffle(State)) %>%
    group_by(State) %>%
    summarise(meanRankDiff = sqrt(mean((as.numeric(incomeRank) - as.numeric(OverallRank))**2, na.rm = TRUE)))

# results after `shuffle( )`
favstats(meanRankDiff ~ State, data = RankDiffSims)
```

```{r}
# how many states have the letter "y" in them?
RegexText <-
  grepl("y", avgIncomeTable$State)
count(RegexText)
```

Fix the second table so the columns have the correct names.
Join the two tables together. Gather the median and standard error of incomes by state and/or year.
Use a user defined function and/ or loop to change the column names.
Use a loop to test the happiness and income for each state.
Use a vectorized function

Visualization for each states median income and the change over time.
Use the standard error to create buffers for the lines
Show the happiness compared to the same years median income and see if there is a correlation between the two. (geomscatter)

Perform a simulation to see what type of happiness correlates best with overall happiness.


